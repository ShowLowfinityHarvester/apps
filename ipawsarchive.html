<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>WSLF Radio's IPAWS Archive 2012-present</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            line-height: 1.6;
            overflow-x: hidden;
            scroll-behavior: smooth;
            position: relative;
        }

        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            background-color: #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            width: 100%;
            z-index: 1000;
            transition: top 0.3s ease-in-out;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInUp 0.8s ease-out forwards;
        }

        .menu-bar img {
            width: 50px;
            margin-right: 20px;
        }

        .menu-items {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        .menu-item {
            margin-right: 20px;
            cursor: pointer;
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
        }

        .menu-item:hover {
            background-color: #fff;
            color: #000;
        }

        .menu-item i {
            margin-right: 8px;
        }

        .dropdown {
            position: relative;
            display: none;
        }

        .dropdown-toggle {
            margin-right: 20px;
            cursor: pointer;
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dropdown-toggle:hover {
            background-color: #fff;
            color: #000;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #3a3a3a;
            min-width: 200px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            color: #e0e0e0;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #fff;
            color: #000;
        }

        #eas-encoder {
            padding: 100px 0 60px;
            background-color: #1a1a1a;
            transition: background 0.5s ease;
            min-height: 100vh;
        }

        #eas-encoder h2 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .project-container {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 10px;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .project-container p.lead {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #e0e0e0;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="date"],
        input[type="text"],
        select {
            width: 100%;
            max-width: 250px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #f0f0f0;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1rem;
        }

        input[type="date"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #11ff00;
        }

        .controls {
            margin-top: 10px;
        }

        button,
        .btn-custom {
            color: #e0e0e0;
            background-color: #3a3a3a;
            border: 1px solid #f0f0f0;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            margin: 0 5px 5px 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            cursor: pointer;
            font-size: 0.95rem;
        }

        button:hover,
        .btn-custom:hover {
            background-color: #11ff00;
            color: #fff;
        }

        p#status {
            color: #d0d0d0;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        .table-container {
            margin-top: 20px;
        }

        .table-dark-custom {
            background-color: #1f1f1f;
            color: #f0f0f0;
        }

        .table-dark-custom th,
        .table-dark-custom td {
            border-color: #444;
            font-size: 0.85rem;
            vertical-align: top;
        }

        .table-dark-custom th {
            background-color: #333;
        }

        .alert-details-toggle {
            font-size: 0.8rem;
        }

        
        .alert-details {
            margin-top: 6px;
            padding: 8px;
            background-color: #111;
            border-radius: 4px;
            max-height: 250px;
            overflow: auto;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            color: #f8f8f8;
            border: 1px solid #333;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #2a2a2a;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.3);
        }

        footer p {
            margin: 0;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* XML Modal styles */
        .xml-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
        }

        .xml-modal-content {
            background-color: #111;
            border-radius: 10px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
        }

        .xml-modal-header,
        .xml-modal-footer {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .xml-modal-footer {
            border-top: 1px solid #333;
            border-bottom: none;
        }

        .xml-modal-header h5 {
            margin: 0;
            font-size: 1rem;
        }

        .xml-modal-body {
            padding: 10px 15px;
            overflow: auto;
            flex: 1;
        }

        .xml-modal-body pre {
            margin: 0;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre;
            color: #f8f8f8;
        }

        .btn-close-custom {
            border: none;
            background: transparent;
            color: #e0e0e0;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
        }

        .btn-close-custom:hover {
            color: #11ff00;
        }

        .xml-modal-footer .btn-custom {
            margin: 0 5px 0 0;
        }

        @media (max-width: 768px) {
            .menu-bar img {
                width: 40px;
            }

            .menu-item, .dropdown-toggle {
                margin-right: 15px;
                font-size: 14px;
                padding: 6px 10px;
            }

            #eas-encoder h2 {
                font-size: 2rem;
            }

            .project-container {
                padding: 15px;
            }

            button,
            .btn-custom {
                padding: 7px 12px;
                font-size: 0.85rem;
            }

            input[type="date"],
            input[type="text"],
            select {
                max-width: 100%;
            }

            .xml-modal-content {
                max-width: 95%;
                width: 95%;
            }
        }

        @media (max-width: 576px) {
            .menu-item, .dropdown-toggle {
                margin-right: 10px;
                font-size: 12px;
                padding: 5px 8px;
            }

            .project-container {
                padding: 10px;
            }

            button,
            .btn-custom {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .xml-modal-header h5 {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div style="display: flex; align-items: center;">
            <img src="https://www.wslfradio.org/WSLF.png" alt="WSLF Logo">
            <div class="menu-items">
                <div class="menu-item" onclick="window.location.href='about'"><i class="fas fa-info-circle"></i> About</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org'"><i class="fas fa-music"></i> WSLF</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org/kec94'"><i class="fas fa-cloud-sun"></i> KEC94</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org/wwg41'"><i class="fas fa-cloud-sun"></i> WWG41</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org/wxl87'"><i class="fas fa-cloud-sun"></i> WXL87</div>
            </div>
        </div>
        <div class="dropdown">
            <div class="dropdown-toggle"><i class="fas fa-bars"></i> More</div>
            <div class="dropdown-menu" id="dropdown-menu">
                <div class="dropdown-item static-item" onclick="window.location.href='status'"><i class="fas fa-signal"></i> Stream Status</div>
                <div class="dropdown-item static-item" onclick="window.location.href='blog'"><i class="fas fa-blog"></i> Blog</div>
                <div class="dropdown-item static-item" onclick="window.location.href='coming-soon'"><i class="fas fa-clock"></i> Coming Soon</div>
                <div class="dropdown-item static-item" onclick="window.location.href='placeholder'"><i class="fas fa-plus"></i> Placeholder</div>
            </div>
        </div>
    </div>

    <section id="eas-encoder">
        <div class="container">
            <h2>IPAWS EAS, WEA, And WXR Archives</h2>
            <div class="project-container">
                <p class="lead">
                    You can wiew archived IPAWS alerts from FEMA's OpenFEMA API here! 2012-present! to view alerts converted into EAS, <a href="httpd://www.wslfradio.org/ipawscap-archive/alerts/">click here</a>.
                </p>

                <!-- Controls row -->
                <div class="row justify-content-center mb-3">
                    <div class="col-md-7">
                        <div class="mb-3">
                            <label for="alert-date">Select Date (UTC)</label>
                            <input type="date" id="alert-date" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label for="msg-type">Message Type (optional)</label>
                            <select id="msg-type" class="form-select">
                                <option value="">Any</option>
                                <option value="Alert">Alert</option>
                                <option value="Update">Update</option>
                                <option value="Cancel">Cancel</option>
                                <option value="Test">Test</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="filter-originators" />
                            <label class="form-check-label" for="filter-originators">
                                Only show CIV and PEP alerts
                            </label>
                        </div>
                        <div class="mb-3">
                            <label for="same-code">SAME / County Code (optional)</label>
                            <input type="text" id="same-code" class="form-control" placeholder="e.g., 035001" />
                        </div>
                        <div class="mb-3">
                            <label for="event-code">Event Code (optional)</label>
                            <input type="text" id="event-code" class="form-control" maxlength="3" placeholder="e.g., HMW" />
                        </div>
                        <div class="controls">
                            <button id="prev-day-btn" title="Previous day (Arrow Left)"><i class="fas fa-arrow-left"></i> Previous Day</button>
                            <button id="load-alerts-btn"><i class="fas fa-cloud-download-alt"></i> Load Alerts</button>
                            <button id="next-day-btn" title="Next day (Arrow Right)">Next Day <i class="fas fa-arrow-right"></i></button>
                            <button id="clear-results-btn" class="btn-custom"><i class="fas fa-trash-alt"></i> Clear</button>
                        </div>
                        <p id="status">Choose a date and click Load Alerts to load in cap products!</p>
                        <small class="status">
                            All data is from FEMA's OpenFEMA IPAWS archive service. Times are in UTC.
                        </small>
                    </div>
                </div>

                <!-- Results table -->
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="alerts-table" class="table table-dark-custom table-striped table-bordered" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Sent (UTC)</th>
                                    <th>Identifier</th>
                                    <th>Sender</th>
                                    <th>Type</th>
                                    <th>SAME</th>
                                    <th>XML</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <p>Â© 2025 WSLF Radio. Some Rights Reserved.</p>
    </footer>

    <!-- XML Modal -->
    <div id="xml-modal" class="xml-modal">
        <div class="xml-modal-content">
            <div class="xml-modal-header">
                <h5 id="xml-modal-title">Alert XML</h5>
                <button id="xml-close-btn" class="btn-close-custom" aria-label="Close">&times;</button>
            </div>
            <div class="xml-modal-body">
                <pre id="xml-modal-body"></pre>
            </div>
            <div class="xml-modal-footer">
                <a id="xml-download-link" class="btn-custom" href="#" download>
                    <i class="fas fa-download"></i> Download XML
                </a>
                <button id="xml-close-btn-footer" class="btn-custom">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    
    const menuItemsContainer = document.querySelector('.menu-items');
    const dropdownMenu = document.querySelector('#dropdown-menu');
    const dropdown = document.querySelector('.dropdown');
    const menuItems = Array.from(document.querySelectorAll('.menu-item'));
    let movedItems = new Map();

    function adjustMenuForMobile() {
        const menuBarRect = document.querySelector('.menu-bar').getBoundingClientRect();
        const dropdownRect = document.querySelector('.dropdown').getBoundingClientRect();
        const maxVisibleX = menuBarRect.width - dropdownRect.width - 20;

        movedItems.forEach((clone, onclick) => {
            const originalItem = menuItems.find(item => item.getAttribute('onclick') === onclick);
            if (originalItem) {
                const cloneRect = clone.getBoundingClientRect();
                if (cloneRect.right <= maxVisibleX && cloneRect.left >= 0) {
                    menuItemsContainer.appendChild(originalItem);
                    clone.remove();
                    movedItems.delete(onclick);
                }
            }
        });

        menuItems.forEach(item => {
            const itemRect = item.getBoundingClientRect();
            if (itemRect.right > maxVisibleX || itemRect.left < 0) {
                const clone = item.cloneNode(true);
                clone.classList.add('dropdown-item');
                clone.classList.remove('menu-item');
                dropdownMenu.appendChild(clone);
                movedItems.set(item.getAttribute('onclick'), clone);
                item.remove();
            }
        });

        dropdown.style.display = movedItems.size > 0 ? 'inline-block' : 'none';
    }

    window.addEventListener('load', adjustMenuForMobile);
    window.addEventListener('resize', adjustMenuForMobile);

    
    const dateInput = document.getElementById('alert-date');
    const msgTypeSelect = document.getElementById('msg-type');
    const filterOriginatorsCheckbox = document.getElementById('filter-originators');
    const sameCodeInput = document.getElementById('same-code');
    const eventCodeInput = document.getElementById('event-code');

    const loadBtn = document.getElementById('load-alerts-btn');
    const clearBtn = document.getElementById('clear-results-btn');
    const prevDayBtn = document.getElementById('prev-day-btn');
    const nextDayBtn = document.getElementById('next-day-btn');

    const statusEl = document.getElementById('status');
    const table = document.getElementById('alerts-table');
    const tbody = document.getElementById('alerts-tbody');

    const MAX_AUTO_DAYS = 10; // how many days forward to auto-advance when filters active

    
    const xmlModal = document.getElementById('xml-modal');
    const xmlModalBody = document.getElementById('xml-modal-body');
    const xmlModalTitle = document.getElementById('xml-modal-title');
    const xmlDownloadLink = document.getElementById('xml-download-link');
    const xmlCloseBtn = document.getElementById('xml-close-btn');
    const xmlCloseBtnFooter = document.getElementById('xml-close-btn-footer');

    
    (function setDefaultDate() {
        const d = new Date();
        d.setUTCDate(d.getUTCDate() - 1);
        const yyyy = d.getUTCFullYear();
        const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
        const dd = String(d.getUTCDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    })();

    clearBtn.addEventListener('click', () => {
        tbody.innerHTML = '';
        table.style.display = 'none';
        statusEl.textContent = 'Data Cleared';
    });

    
    function getElementsByLocalName(root, name) {
        let els = root.getElementsByTagName(name);
        if (els && els.length) return els;
        if (root.getElementsByTagNameNS) {
            els = root.getElementsByTagNameNS('*', name);
            if (els && els.length) return els;
        }
        return [];
    }

    
    function isIgnoredSender(sender) {
        if (!sender) return false;
        return sender.trim().toLowerCase() === 'w-nws.webmaster@noaa.gov';
    }

    
    function matchesSameCode(xmlString, sameCode) {
        if (!sameCode || !xmlString) return true; 
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlString, "application/xml");
            const geocodes = getElementsByLocalName(doc, "geocode");
            for (let i = 0; i < geocodes.length; i++) {
                const g = geocodes[i];
                const valueNameEl = getElementsByLocalName(g, "valueName")[0];
                const valueEl = getElementsByLocalName(g, "value")[0];
                if (!valueNameEl || !valueEl) continue;
                const name = (valueNameEl.textContent || "").trim();
                const val = (valueEl.textContent || "").trim();
                if (name === "SAME" && val.includes(sameCode)) {
                    return true;
                }
            }
            
            return xmlString.includes(sameCode);
        } catch (e) {
            return xmlString.includes(sameCode);
        }
    }

    
    function matchesEventCode(xmlString, evtCode) {
        if (!evtCode || !xmlString) return true; 
        const code = evtCode.toUpperCase();
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlString, "application/xml");
            const eventCodes = getElementsByLocalName(doc, "eventCode");
            for (let i = 0; i < eventCodes.length; i++) {
                const ec = eventCodes[i];
                const valueNameEl = getElementsByLocalName(ec, "valueName")[0];
                const valueEl = getElementsByLocalName(ec, "value")[0];
                if (!valueNameEl || !valueEl) continue;
                const name = (valueNameEl.textContent || "").trim();
                const val = (valueEl.textContent || "").trim().toUpperCase();
                if (name === "SAME" && val === code) {
                    return true;
                }
            }
            // Fallback substring, but anchored in <value> tags
            return xmlString.includes(`<value>${code}</value>`);
        } catch (e) {
            return xmlString.includes(`<value>${code}</value>`) || xmlString.toUpperCase().includes(code);
        }
    }

    // Extract SAME event code (e.g., RWT) from originalMessage XML for display
    function extractSameEventCode(xmlString) {
        if (!xmlString) return '';
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlString, "application/xml");
            const eventCodes = getElementsByLocalName(doc, "eventCode");

            for (let i = 0; i < eventCodes.length; i++) {
                const ec = eventCodes[i];
                const valueNameEl = getElementsByLocalName(ec, "valueName")[0];
                const valueEl = getElementsByLocalName(ec, "value")[0];
                if (!valueNameEl || !valueEl) continue;

                const name = (valueNameEl.textContent || "").trim().toUpperCase();
                if (name === "SAME") {
                    return (valueEl.textContent || "").trim().toUpperCase();
                }
            }

            // Fallback regex if DOM parsing fails
            const match = xmlString.match(
                /<eventCode>\s*<valueName>\s*SAME\s*<\/valueName>\s*<value>\s*([A-Za-z0-9]+)\s*<\/value>/i
            );
            return match ? match[1].toUpperCase() : '';
        } catch (e) {
            const match = xmlString.match(
                /<eventCode>\s*<valueName>\s*SAME\s*<\/valueName>\s*<value>\s*([A-Za-z0-9]+)\s*<\/value>/i
            );
            return match ? match[1].toUpperCase() : '';
        }
    }

    function anyFiltersActive() {
        return filterOriginatorsCheckbox.checked ||
               (sameCodeInput.value && sameCodeInput.value.trim() !== "") ||
               (eventCodeInput.value && eventCodeInput.value.trim() !== "");
    }

    // Pretty-print XML similar to how browsers format it
    function formatXml(xml) {
        if (!xml) return '';
        // First, add line breaks between tags
        xml = xml.replace(/>\s*</g, '>\n<');
        const lines = xml.split('\n');
        let indent = 0;
        const formatted = [];

        const indentChar = '  '; // two spaces

        lines.forEach(line => {
            let trimmed = line.trim();
            if (!trimmed) return;

            if (/^<\/.+>/.test(trimmed)) {
                // Closing tag, decrease indent first
                indent = Math.max(indent - 1, 0);
            }

            formatted.push(indentChar.repeat(indent) + trimmed);

            if (/^<[^!?/].*[^/]>$/.test(trimmed) && !/^<.+<\/.+>$/.test(trimmed)) {
                // Opening tag (not self closing, not on same line as closing)
                indent++;
            }
        });

        return formatted.join('\n');
    }

    function openXmlModal(xmlString, identifier) {
        const formatted = formatXml(xmlString || '(no originalMessage provided)');
        xmlModalBody.textContent = formatted;
        xmlModalTitle.textContent = identifier ? `Viewing the XML of ${identifier}` : 'Alert XML';
        xmlModal.style.display = 'flex';

        // Prepare download link
        const blob = new Blob([xmlString || ''], { type: 'application/xml' });
        if (xmlDownloadLink.dataset.url) {
            URL.revokeObjectURL(xmlDownloadLink.dataset.url);
        }
        const url = URL.createObjectURL(blob);
        xmlDownloadLink.href = url;
        xmlDownloadLink.download = (identifier ? identifier : 'alert') + '.xml';
        xmlDownloadLink.dataset.url = url;
    }

    function closeXmlModal() {
        xmlModal.style.display = 'none';
        if (xmlDownloadLink.dataset.url) {
            URL.revokeObjectURL(xmlDownloadLink.dataset.url);
            delete xmlDownloadLink.dataset.url;
        }
    }

    xmlCloseBtn.addEventListener('click', closeXmlModal);
    xmlCloseBtnFooter.addEventListener('click', closeXmlModal);

    // Close on clicking outside content
    xmlModal.addEventListener('click', (e) => {
        if (e.target === xmlModal) {
            closeXmlModal();
        }
    });

    // Close on Escape
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && xmlModal.style.display === 'flex') {
            closeXmlModal();
        }
    });

    // Fetch and filter alerts for a single date; returns {dateStr, alerts, meta}
    async function fetchAlertsForDate(dateStr) {
        const msgType = msgTypeSelect.value;
        const filterOriginators = filterOriginatorsCheckbox.checked;
        const sameCode = sameCodeInput.value.trim();
        const evtCode = eventCodeInput.value.trim();

        // Build UTC start/end
        const start = `${dateStr}T00:00:00Z`;
        const d = new Date(dateStr + 'T00:00:00Z');
        const nextDay = new Date(d.getTime() + 24 * 60 * 60 * 1000);
        const yyyy = nextDay.getUTCFullYear();
        const mm = String(nextDay.getUTCMonth() + 1).padStart(2, '0');
        const dd = String(nextDay.getUTCDate()).padStart(2, '0');
        const end = `${yyyy}-${mm}-${dd}T00:00:00Z`;

        let filter = `sent ge '${start}' and sent lt '${end}'`;
        if (msgType) {
            filter += ` and msgType eq '${msgType}'`;
        }

        const baseUrl = 'https://www.fema.gov/api/open/v1/IpawsArchivedAlerts';
        const url = `${baseUrl}?$filter=${encodeURIComponent(filter)}&$top=1000`;

        const resp = await fetch(url);
        if (!resp.ok) {
            throw new Error('HTTP ' + resp.status);
        }
        const data = await resp.json();
        let alerts = data.IpawsArchivedAlerts || [];
        const meta = data.metadata || {};

        // Apply client-side filters
        alerts = alerts.filter(a => {
            const xml = a.originalMessage || "";
            const sender = a.sender || "";

            // If checkbox is on, hide alerts from NWS WXR sender
            if (filterOriginators && isIgnoredSender(sender)) return false;

            if (!matchesSameCode(xml, sameCode)) return false;
            if (!matchesEventCode(xml, evtCode)) return false;
            return true;
        });

        return { dateStr, alerts, meta };
    }

    function setDateFromOffset(offsetDays) {
        if (!dateInput.value) return;
        const d = new Date(dateInput.value + 'T00:00:00Z');
        d.setUTCDate(d.getUTCDate() + offsetDays);
        const yyyy = d.getUTCFullYear();
        const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
        const dd = String(d.getUTCDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    // Render results into table
    function renderAlerts(result, autoAdvancedSteps = 0) {
        const { dateStr, alerts, meta } = result;
        tbody.innerHTML = '';

        if (alerts.length === 0) {
            table.style.display = 'none';
            if (anyFiltersActive() && autoAdvancedSteps > 0) {
                statusEl.textContent = `No alerts matched filters on the selected date or the next ${autoAdvancedSteps} day(s).`;
            } else {
                statusEl.textContent = `No alerts matched filters for ${dateStr}.`;
            }
            return;
        }

        alerts.forEach(alert => {
            const tr = document.createElement('tr');

            const sent = alert.sent || '';
            const identifier = alert.identifier || '';
            const sender = alert.sender || '';
            const msgTypeVal = alert.msgType || '';
            const originalXml = alert.originalMessage || '(no originalMessage provided)';
            const sameEventCode = extractSameEventCode(alert.originalMessage || '');

            const tdSent = document.createElement('td');
            tdSent.textContent = sent;

            const tdId = document.createElement('td');
            tdId.textContent = identifier;

            const tdSender = document.createElement('td');
            tdSender.textContent = sender;

            const tdType = document.createElement('td');
            tdType.textContent = msgTypeVal;

            const tdSame = document.createElement('td');
            tdSame.textContent = sameEventCode || '';

            const tdXml = document.createElement('td');
            const viewBtn = document.createElement('button');
            viewBtn.className = 'btn-custom alert-details-toggle';
            viewBtn.type = 'button';
            viewBtn.innerHTML = '<i class="fas fa-eye"></i> View XML';
            viewBtn.addEventListener('click', () => {
                openXmlModal(originalXml, identifier);
            });
            tdXml.appendChild(viewBtn);

            tr.appendChild(tdSent);
            tr.appendChild(tdId);
            tr.appendChild(tdSender);
            tr.appendChild(tdType);
            tr.appendChild(tdSame);
            tr.appendChild(tdXml);

            tbody.appendChild(tr);
        });

        table.style.display = '';
        const filterNote = anyFiltersActive() ? ' (filters applied)' : '';
        const autoNote = autoAdvancedSteps > 0 ? ` (auto-advanced ${autoAdvancedSteps} day(s) forward)` : '';
        const apiNote = meta.count !== undefined ? ` API reported count (unfiltered): ${meta.count}.` : '';
        statusEl.textContent = `Showing ${alerts.length} alert(s) for ${dateStr}${filterNote}${autoNote}.${apiNote}`;
    }

    // Main loader with optional auto-advance
    async function loadAlerts(autoAdvanceForward = true) {
        const startDate = dateInput.value;
        if (!startDate) {
            alert('Please choose a date.');
            return;
        }

        tbody.innerHTML = '';
        table.style.display = 'none';
        statusEl.textContent = 'Loading alerts from FEMA...';

        try {
            // First, try the selected date
            let result = await fetchAlertsForDate(startDate);
            if (result.alerts.length > 0 || !anyFiltersActive() || !autoAdvanceForward) {
                // Either we found alerts, or no filters, or we don't auto-advance
                dateInput.value = result.dateStr;
                renderAlerts(result, 0);
                return;
            }

            // Auto-advance forward up to MAX_AUTO_DAYS until we find something
            let steps = 0;
            let currentDate = startDate;
            while (steps < MAX_AUTO_DAYS && result.alerts.length === 0) {
                steps++;
                const d = new Date(currentDate + 'T00:00:00Z');
                d.setUTCDate(d.getUTCDate() + 1);
                const yyyy = d.getUTCFullYear();
                const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
                const dd = String(d.getUTCDate()).padStart(2, '0');
                currentDate = `${yyyy}-${mm}-${dd}`;
                result = await fetchAlertsForDate(currentDate);
            }

            dateInput.value = result.dateStr;
            renderAlerts(result, result.alerts.length > 0 ? steps : steps);
        } catch (err) {
            console.error(err);
            statusEl.textContent = 'Error loading alerts: ' + err.message;
            table.style.display = 'none';
        }
    }

    loadBtn.addEventListener('click', () => loadAlerts(true));

    prevDayBtn.addEventListener('click', () => {
        if (!dateInput.value) return;
        setDateFromOffset(-1);
        loadAlerts(false); // no auto-advance when manually stepping
    });

    nextDayBtn.addEventListener('click', () => {
        if (!dateInput.value) return;
        setDateFromOffset(1);
        loadAlerts(false); // no auto-advance when manually stepping
    });

    // Keyboard navigation: ArrowLeft/ArrowRight for previous/next day
    window.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'select' || tag === 'textarea') return;
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            prevDayBtn.click();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            nextDayBtn.click();
        }
    });
</script>

</body>
</html>
