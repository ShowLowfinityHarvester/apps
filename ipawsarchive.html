<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>WSLF Radio's IPAWS Daily Alert Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            line-height: 1.6;
            overflow-x: hidden;
            scroll-behavior: smooth;
            position: relative;
        }

        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            background-color: #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            width: 100%;
            z-index: 1000;
            transition: top 0.3s ease-in-out;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInUp 0.8s ease-out forwards;
        }

        .menu-bar img {
            width: 50px;
            margin-right: 20px;
        }

        .menu-items {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        .menu-item {
            margin-right: 20px;
            cursor: pointer;
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
        }

        .menu-item:hover {
            background-color: #fff;
            color: #000;
        }

        .menu-item i {
            margin-right: 8px;
        }

        .dropdown {
            position: relative;
            display: none;
        }

        .dropdown-toggle {
            margin-right: 20px;
            cursor: pointer;
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dropdown-toggle:hover {
            background-color: #fff;
            color: #000;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #3a3a3a;
            min-width: 200px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            color: #e0e0e0;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #fff;
            color: #000;
        }

        #eas-encoder {
            padding: 100px 0 60px;
            background-color: #1a1a1a;
            transition: background 0.5s ease;
            min-height: 100vh;
        }

        #eas-encoder h2 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .project-container {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 10px;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .project-container p.lead {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #e0e0e0;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="date"],
        select {
            width: 100%;
            max-width: 250px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #f0f0f0;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1rem;
        }

        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #11ff00;
        }

        .controls {
            margin-top: 10px;
        }

        button,
        .btn-custom {
            color: #e0e0e0;
            background-color: #3a3a3a;
            border: 1px solid #f0f0f0;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            margin: 0 5px 5px 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            cursor: pointer;
            font-size: 0.95rem;
        }

        button:hover,
        .btn-custom:hover {
            background-color: #11ff00;
            color: #fff;
        }

        p#status {
            color: #d0d0d0;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        .table-container {
            margin-top: 20px;
        }

        .table-dark-custom {
            background-color: #1f1f1f;
            color: #f0f0f0;
        }

        .table-dark-custom th,
        .table-dark-custom td {
            border-color: #444;
            font-size: 0.85rem;
            vertical-align: top;
        }

        .table-dark-custom th {
            background-color: #333;
        }

        .alert-details-toggle {
            font-size: 0.8rem;
        }

        .alert-details {
            margin-top: 6px;
            padding: 8px;
            background-color: #111;
            border-radius: 4px;
            max-height: 200px;
            overflow: auto;
            font-family: monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #2a2a2a;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.3);
        }

        footer p {
            margin: 0;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile tweaks */
        @media (max-width: 768px) {
            .menu-bar img {
                width: 40px;
            }

            .menu-item, .dropdown-toggle {
                margin-right: 15px;
                font-size: 14px;
                padding: 6px 10px;
            }

            #eas-encoder h2 {
                font-size: 2rem;
            }

            .project-container {
                padding: 15px;
            }

            button,
            .btn-custom {
                padding: 7px 12px;
                font-size: 0.85rem;
            }

            input[type="date"],
            select {
                max-width: 100%;
            }
        }

        @media (max-width: 576px) {
            .menu-item, .dropdown-toggle {
                margin-right: 10px;
                font-size: 12px;
                padding: 5px 8px;
            }

            .project-container {
                padding: 10px;
            }

            button,
            .btn-custom {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div style="display: flex; align-items: center;">
            <img src="https://www.wslfradio.org/WSLF.png" alt="WSLF Logo">
            <div class="menu-items">
                <div class="menu-item" onclick="window.location.href='about'"><i class="fas fa-info-circle"></i> About</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org'"><i class="fas fa-music"></i> WSLF</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org/kec94'"><i class="fas fa-cloud-sun"></i> KEC94</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org/wwg41'"><i class="fas fa-cloud-sun"></i> WWG41</div>
                <div class="menu-item" onclick="window.location.href='https://www.wslfradio.org/wxl87'"><i class="fas fa-cloud-sun"></i> WXL87</div>
            </div>
        </div>
        <div class="dropdown">
            <div class="dropdown-toggle"><i class="fas fa-bars"></i> More</div>
            <div class="dropdown-menu" id="dropdown-menu">
                <div class="dropdown-item static-item" onclick="window.location.href='status'"><i class="fas fa-signal"></i> Stream Status</div>
                <div class="dropdown-item static-item" onclick="window.location.href='blog'"><i class="fas fa-blog"></i> Blog</div>
                <div class="dropdown-item static-item" onclick="window.location.href='coming-soon'"><i class="fas fa-clock"></i> Coming Soon</div>
                <div class="dropdown-item static-item" onclick="window.location.href='placeholder'"><i class="fas fa-plus"></i> Placeholder</div>
            </div>
        </div>
    </div>

    <section id="eas-encoder">
        <div class="container">
            <h2>IPAWS / FEMA Daily Alert Viewer</h2>
            <div class="project-container">
                <p class="lead">
                    View archived IPAWS alerts from FEMA's OpenFEMA API, one day at a time.
                </p>

                <!-- Controls row -->
                <div class="row justify-content-center mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="alert-date">Select Date (UTC)</label>
                            <input type="date" id="alert-date" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label for="msg-type">Message Type (optional)</label>
                            <select id="msg-type" class="form-select">
                                <option value="">Any</option>
                                <option value="Alert">Alert</option>
                                <option value="Update">Update</option>
                                <option value="Cancel">Cancel</option>
                                <option value="Test">Test</option>
                            </select>
                        </div>
                        <!-- NEW: Checkbox to filter to CIV originator -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="filter-civ" />
                            <label class="form-check-label" for="filter-civ">
                                Only show CIV-originator alerts (EAS-ORG = CIV)
                            </label>
                        </div>
                        <div class="controls">
                            <button id="load-alerts-btn"><i class="fas fa-cloud-download-alt"></i> Load Alerts</button>
                            <button id="clear-results-btn" class="btn-custom"><i class="fas fa-trash-alt"></i> Clear</button>
                        </div>
                        <p id="status">Choose a date and click "Load Alerts" to begin.</p>
                        <small class="text-muted">
                            Data source: FEMA OpenFEMA IPAWS Archived Alerts. Times are in UTC.
                        </small>
                    </div>
                </div>

                <!-- Results table -->
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="alerts-table" class="table table-dark-custom table-striped table-bordered" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Sent (UTC)</th>
                                    <th>Identifier</th>
                                    <th>Sender</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <p>Â© 2025 WSLF Radio. Some Rights Reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Mobile menu adjustments ---
        const menuItemsContainer = document.querySelector('.menu-items');
        const dropdownMenu = document.querySelector('#dropdown-menu');
        const dropdown = document.querySelector('.dropdown');
        const menuItems = Array.from(document.querySelectorAll('.menu-item'));
        let movedItems = new Map();

        function adjustMenuForMobile() {
            const menuBarRect = document.querySelector('.menu-bar').getBoundingClientRect();
            const dropdownRect = document.querySelector('.dropdown').getBoundingClientRect();
            const maxVisibleX = menuBarRect.width - dropdownRect.width - 20;

            // move items back if there's room
            movedItems.forEach((clone, onclick) => {
                const originalItem = menuItems.find(item => item.getAttribute('onclick') === onclick);
                if (originalItem) {
                    const cloneRect = clone.getBoundingClientRect();
                    if (cloneRect.right <= maxVisibleX && cloneRect.left >= 0) {
                        menuItemsContainer.appendChild(originalItem);
                        clone.remove();
                        movedItems.delete(onclick);
                    }
                }
            });

            // move overflowing items into dropdown
            menuItems.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                if (itemRect.right > maxVisibleX || itemRect.left < 0) {
                    const clone = item.cloneNode(true);
                    clone.classList.add('dropdown-item');
                    clone.classList.remove('menu-item');
                    dropdownMenu.appendChild(clone);
                    movedItems.set(item.getAttribute('onclick'), clone);
                    item.remove();
                }
            });

            dropdown.style.display = movedItems.size > 0 ? 'inline-block' : 'none';
        }

        window.addEventListener('load', adjustMenuForMobile);
        window.addEventListener('resize', adjustMenuForMobile);

        // --- IPAWS Daily Alert Viewer logic ---
        const dateInput = document.getElementById('alert-date');
        const msgTypeSelect = document.getElementById('msg-type');
        const filterCivCheckbox = document.getElementById('filter-civ');
        const loadBtn = document.getElementById('load-alerts-btn');
        const clearBtn = document.getElementById('clear-results-btn');
        const statusEl = document.getElementById('status');
        const table = document.getElementById('alerts-table');
        const tbody = document.getElementById('alerts-tbody');

        // Set default date to yesterday (UTC) but do NOT auto-load
        (function setDefaultDate() {
            const d = new Date();
            d.setUTCDate(d.getUTCDate() - 1);
            const yyyy = d.getUTCFullYear();
            const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(d.getUTCDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        })();

        clearBtn.addEventListener('click', () => {
            tbody.innerHTML = '';
            table.style.display = 'none';
            statusEl.textContent = 'Results cleared. Choose a date and click "Load Alerts" to begin.';
        });

        // Helper: check if originalMessage has <valueName>EAS-ORG</valueName><value>CIV</value>
        function hasCivOriginator(xmlString) {
            if (!xmlString) return false;
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlString, "application/xml");
                const params = doc.getElementsByTagName("parameter");
                for (let i = 0; i < params.length; i++) {
                    const param = params[i];
                    const valueNameEl = param.getElementsByTagName("valueName")[0];
                    const valueEl = param.getElementsByTagName("value")[0];
                    if (!valueNameEl || !valueEl) continue;

                    const name = (valueNameEl.textContent || "").trim();
                    const val = (valueEl.textContent || "").trim();
                    if (name === "EAS-ORG" && val === "CIV") {
                        return true;
                    }
                }
                // Fallback: raw substring check if parsing didn't find it
                if (xmlString.includes("<valueName>EAS-ORG</valueName>") &&
                    xmlString.includes("<value>CIV</value>")) {
                    return true;
                }
                return false;
            } catch (e) {
                // If XML is malformed, last-resort string search
                return xmlString.includes("<valueName>EAS-ORG</valueName>") &&
                       xmlString.includes("<value>CIV</value>");
            }
        }

        loadBtn.addEventListener('click', async () => {
            const dateStr = dateInput.value;
            const msgType = msgTypeSelect.value;
            const filterCiv = filterCivCheckbox.checked;

            if (!dateStr) {
                alert('Please choose a date.');
                return;
            }

            tbody.innerHTML = '';
            table.style.display = 'none';
            statusEl.textContent = 'Loading alerts from FEMA...';

            // Build UTC start and end for that date
            const start = `${dateStr}T00:00:00Z`;
            const d = new Date(dateStr + 'T00:00:00Z');
            const nextDay = new Date(d.getTime() + 24 * 60 * 60 * 1000);
            const yyyy = nextDay.getUTCFullYear();
            const mm = String(nextDay.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(nextDay.getUTCDate()).padStart(2, '0');
            const end = `${yyyy}-${mm}-${dd}T00:00:00Z`;

            let filter = `sent ge '${start}' and sent lt '${end}'`;
            if (msgType) {
                filter += ` and msgType eq '${msgType}'`;
            }

            const baseUrl = 'https://www.fema.gov/api/open/v1/IpawsArchivedAlerts';
            const url = `${baseUrl}?$filter=${encodeURIComponent(filter)}&$top=1000`;

            try {
                const resp = await fetch(url);
                if (!resp.ok) {
                    throw new Error('HTTP ' + resp.status);
                }
                const data = await resp.json();
                let alerts = data.IpawsArchivedAlerts || [];
                const meta = data.metadata || {};

                // Apply CIV-originator filter on the client if requested
                if (filterCiv) {
                    alerts = alerts.filter(a => hasCivOriginator(a.originalMessage));
                }

                statusEl.textContent = `Found ${alerts.length} alerts for ${dateStr}` +
                    (filterCiv ? ' (CIV-originator only).' : '.') +
                    (meta.count !== undefined ? ` API reported count: ${meta.count}.` : '');

                if (alerts.length === 0) {
                    table.style.display = 'none';
                    return;
                }

                alerts.forEach((alert) => {
                    const tr = document.createElement('tr');

                    const sent = alert.sent || '';
                    const identifier = alert.identifier || '';
                    const sender = alert.sender || '';
                    const msgTypeVal = alert.msgType || '';
                    const originalXml = alert.originalMessage || '(no originalMessage provided)';

                    const tdSent = document.createElement('td');
                    tdSent.textContent = sent;

                    const tdId = document.createElement('td');
                    tdId.textContent = identifier;

                    const tdSender = document.createElement('td');
                    tdSender.textContent = sender;

                    const tdType = document.createElement('td');
                    tdType.textContent = msgTypeVal;

                    const tdActions = document.createElement('td');

                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'btn-custom alert-details-toggle';
                    toggleBtn.type = 'button';
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i> View XML';

                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'alert-details';
                    detailsDiv.textContent = originalXml;
                    detailsDiv.style.display = 'none';

                    toggleBtn.addEventListener('click', () => {
                        const visible = detailsDiv.style.display === 'block';
                        detailsDiv.style.display = visible ? 'none' : 'block';
                        toggleBtn.innerHTML = visible
                            ? '<i class="fas fa-eye"></i> View XML'
                            : '<i class="fas fa-eye-slash"></i> Hide XML';
                    });

                    tdActions.appendChild(toggleBtn);
                    tdActions.appendChild(detailsDiv);

                    tr.appendChild(tdSent);
                    tr.appendChild(tdId);
                    tr.appendChild(tdSender);
                    tr.appendChild(tdType);
                    tr.appendChild(tdActions);

                    tbody.appendChild(tr);
                });

                table.style.display = '';
            } catch (err) {
                console.error(err);
                statusEl.textContent = 'Error loading alerts: ' + err.message;
                table.style.display = 'none';
            }
        });
    </script>
</body>
</html>
